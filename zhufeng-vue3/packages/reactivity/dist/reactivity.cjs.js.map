{"version":3,"file":"reactivity.cjs.js","sources":["../../shared/src/index.ts","../src/baseHandler.ts","../src/reactive.ts"],"sourcesContent":["export const isObject = (value) => {\n  return typeof value === \"object\" && value !== null\n}\n\nexport const extend = Object.assign;","// 实现 new Proxy(target, handler)\n// 是不是仅读的，仅读的属性 set 时候会报异常\n// 是不是深度的，\n\nimport {extend, isObject} from \"@vue/shared\";\nimport {reactive, readonly} from \"@vue/reactivity\";\n\nfunction createGetter(isReadonly = false, shallow = false) {\n  return function get(target, key, receiver) {\n    // proxy + reflect\n    const res = Reflect.get(target, key, receiver)\n    // 后续 object 上的方法，会被迁移到 Reflect Reflect.getProptypeof()\n    // 以前 target[key] = value 方式 设置值可能会失败，但是并不会报异常，也没有返回值标识\n    // Reflect 方法具备返回值\n    // Reflect 使用可以不使用 proxy es6语法\n    if (!isReadonly) {\n      // 这里要收集依赖，等会数据变化后更新对应的视图\n    }\n    if (shallow) {\n      return res\n    }\n    if (isObject(res)) {\n      // vue2 是一上来就递归\n      // Vue3 是当取值的时候才进行带来，vue3的代理模式是懒代理\n      return isReadonly ? readonly(res) : reactive(res)\n    }\n    return res\n  }\n}\n\nconst get = createGetter();\nconst shallowGet = createGetter(false, true);\nconst readonlyGet = createGetter(true, false);\nconst shallowReadonlyGet = createGetter(true, true);\n\n\nfunction createSetter(shallow = false) {\n\n  return function set(target, key, value, receiver) {\n    const res = Reflect.set(target, key, value, receiver)\n\n    return res\n  }\n}\n\nconst set = createSetter()\nconst shallowSet = createSetter(true);\n\nexport const mutableHanders = {\n  get,\n  set\n};\nexport const shallowReactiveHandlers = {\n  get: shallowGet,\n  set: shallowSet,\n};\n\nconst readonlyObj = {\n  set: (target, key) => {\n    console.warn(`set on ky ${key} failed`);\n  },\n};\nexport const readonlyHandlers = extend(\n  {\n    get: readonlyGet,\n  },\n  readonlyObj,\n);\nexport const shallowReadonlyHandlers = extend(\n  {\n    get: shallowReadonlyGet,\n  },\n  readonlyObj,\n);\n","import { isObject } from \"@vue/shared\";\nimport {\n  mutableHanders,\n  readonlyHandlers,\n  shallowReadonlyHandlers,\n  shallowReactiveHandlers,\n} from \"./baseHandler\";\n\nexport function reactive(target) {\n  return createReactiveObject(target, false, mutableHanders);\n}\n\nexport function shallowReactive(target) {\n  return createReactiveObject(target, false, shallowReactiveHandlers);\n}\n\nexport function readonly(target) {\n  return createReactiveObject(target, true, readonlyHandlers);\n}\n\nexport function shallowReadonly(target) {\n  return createReactiveObject(target, true, shallowReadonlyHandlers);\n}\n\n// 会垃圾回收，不会造成内存泄露， 存储的 key 只能是对象\nconst reactiveMap = new WeakMap();\nconst readonlyMap = new WeakMap();\n\n// 是不是深度，是不是仅读，做柯里化\n//new Proxy 最核心的需要拦截，数据的读取和数据的修改 get set\nexport function createReactiveObject(target, isReadonly, baseHandler) {\n  // 如果目标不是对象，没法拦截了，reactive 这个 api 只能拦截对象类型\n  if (!isObject(target)) {\n    return;\n  }\n  // 如果某个对象已经被代理过了，就不要再代理了。可能一个对象，被代理是深度，又被仅读代理了\n  const proxyMap = isReadonly ? readonlyMap : reactiveMap;\n\n  let existMap = proxyMap.get(target);\n  if (existMap) {\n    // 如果已经被代理了，就直接返回即可\n    return existMap;\n  }\n\n  const proxy = new Proxy(target, baseHandler);\n  // 将要代理的对象和对应代理结果缓存起来\n  proxyMap.set(target, proxy);\n\n  return proxy;\n}\n"],"names":[],"mappings":"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"}