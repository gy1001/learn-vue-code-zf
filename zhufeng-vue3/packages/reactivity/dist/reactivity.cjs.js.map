{"version":3,"file":"reactivity.cjs.js","sources":["../../shared/src/index.ts","../src/baseHandler.ts","../src/reactive.ts","../src/effect.ts"],"sourcesContent":["export const isObject = (value) => {\n  return typeof value === \"object\" && value !== null\n}\n\nexport const extend = Object.assign;","// 实现 new Proxy(target, handler)\n// 是不是仅读的，仅读的属性 set 时候会报异常\n// 是不是深度的，\n\nimport {extend, isObject} from \"@vue/shared\";\nimport {reactive, readonly, track, TrackOpTypes} from \"@vue/reactivity\";\n\nfunction createGetter(isReadonly = false, shallow = false) {\n  return function get(target, key, receiver) {\n    // proxy + reflect\n    const res = Reflect.get(target, key, receiver)\n    // 后续 object 上的方法，会被迁移到 Reflect Reflect.getProptypeof()\n    // 以前 target[key] = value 方式 设置值可能会失败，但是并不会报异常，也没有返回值标识\n    // Reflect 方法具备返回值\n    // Reflect 使用可以不使用 proxy es6语法\n    if (!isReadonly) {\n      // 这里要收集依赖，等会数据变化后更新对应的视图\n      console.log(\"执行 effect 时候会取值，收集 effect\")\n      track(target, TrackOpTypes.GET, key)\n    }\n    if (shallow) {\n      return res\n    }\n    if (isObject(res)) {\n      // vue2 是一上来就递归\n      // Vue3 是当取值的时候才进行带来，vue3的代理模式是懒代理\n      return isReadonly ? readonly(res) : reactive(res)\n    }\n    return res\n  }\n}\n\nconst get = createGetter();\nconst shallowGet = createGetter(false, true);\nconst readonlyGet = createGetter(true, false);\nconst shallowReadonlyGet = createGetter(true, true);\n\n\nfunction createSetter(shallow = false) {\n\n  return function set(target, key, value, receiver) {\n    const res = Reflect.set(target, key, value, receiver)\n    // 当数据更新的时候 ，通知对应属性的 effect 重新执行\n    return res\n  }\n}\n\nconst set = createSetter()\nconst shallowSet = createSetter(true);\n\nexport const mutableHanders = {\n  get,\n  set\n};\nexport const shallowReactiveHandlers = {\n  get: shallowGet,\n  set: shallowSet,\n};\n\nconst readonlyObj = {\n  set: (target, key) => {\n    console.warn(`set on ky ${key} failed`);\n  },\n};\nexport const readonlyHandlers = extend(\n  {\n    get: readonlyGet,\n  },\n  readonlyObj,\n);\nexport const shallowReadonlyHandlers = extend(\n  {\n    get: shallowReadonlyGet,\n  },\n  readonlyObj,\n);\n","import { isObject } from \"@vue/shared\";\nimport {\n  mutableHanders,\n  readonlyHandlers,\n  shallowReadonlyHandlers,\n  shallowReactiveHandlers,\n} from \"./baseHandler\";\n\nexport function reactive(target) {\n  return createReactiveObject(target, false, mutableHanders);\n}\n\nexport function shallowReactive(target) {\n  return createReactiveObject(target, false, shallowReactiveHandlers);\n}\n\nexport function readonly(target) {\n  return createReactiveObject(target, true, readonlyHandlers);\n}\n\nexport function shallowReadonly(target) {\n  return createReactiveObject(target, true, shallowReadonlyHandlers);\n}\n\n// 会垃圾回收，不会造成内存泄露， 存储的 key 只能是对象\nconst reactiveMap = new WeakMap();\nconst readonlyMap = new WeakMap();\n\n// 是不是深度，是不是仅读，做柯里化\n//new Proxy 最核心的需要拦截，数据的读取和数据的修改 get set\nexport function createReactiveObject(target, isReadonly, baseHandler) {\n  // 如果目标不是对象，没法拦截了，reactive 这个 api 只能拦截对象类型\n  if (!isObject(target)) {\n    return;\n  }\n  // 如果某个对象已经被代理过了，就不要再代理了。可能一个对象，被代理是深度，又被仅读代理了\n  const proxyMap = isReadonly ? readonlyMap : reactiveMap;\n\n  let existMap = proxyMap.get(target);\n  if (existMap) {\n    // 如果已经被代理了，就直接返回即可\n    return existMap;\n  }\n\n  const proxy = new Proxy(target, baseHandler);\n  // 将要代理的对象和对应代理结果缓存起来\n  proxyMap.set(target, proxy);\n\n  return proxy;\n}\n","export function effect(fn, options: any = {}) {\n  // 我们需要让这个 effect 变成响应式的 effect，可以做到数据变化重新执行\n\n  const effect = createReactiveEffect(fn, options)\n\n  if (!options.lazy) {\n    effect() // 响应式的 effect 默认会先执行一次\n  }\n  return effect\n}\n\nlet uid = 0\nlet activeEffect\nlet effectStack = [] // 存储当前的 effect,需要是个栈，因为可能会有嵌套的问题\n/*\neffect(() => {\n  state.name = \"xx\"\n  effect(() => {\n     state.age = \"xxx\"\n  })\n  state.address = \"xxx\"\n})\n\n\n */\n\n\nfunction createReactiveEffect(fn, options = {}) {\n  const effect = function reactiveEffect() {\n    if (effectStack.includes(effect)) {\n      // 这里可以防止如下代码\n      /**\n       effect(() => { state.age ++  })\n       // 如果没有做判断，就会循环执行\n       */\n      return\n    }\n    // 后续保证 effect 没有加入到 effectStack 中才进行添加\n\n    try {\n      // console.log(\"默认会执行\")\n      effectStack.push(effect)\n      activeEffect = effect\n      return fn()// 函数取值的时候会取值，执行 get，\n    } finally {\n      effectStack.pop()\n      activeEffect = effectStack[effectStack.length - 1]\n    }\n  }\n  effect.id = uid++ // 制作一个 effect 标识，用于区分 effect\n  effect._isEffect = true // 用于标识这个是响应式 effect\n  effect.raw = fn // 保留 effect 对应的原函数\n  effect.options = options // 在 effect 上保存用户的属性\n  return effect\n}\n\nconst targetMap = new WeakMap()\n\n// 让某个对象中的属性收集当前对应的 effect 函数\nexport function track(target, type, key) {\n  // 这里就可以拿到 activeEffect: 它是当前正在运行的 effect\n  // console.log(target, key, activeEffect)\n  if (activeEffect === undefined) {\n    // 此属性不用收集依赖，因为没在 effect 中使用\n    return\n  }\n  let depsMap = targetMap.get(target)\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map()))\n  }\n\n  let dep = depsMap.get(key)\n  if (!dep) {\n    depsMap.set(key, dep = new Set())\n  }\n  if (!dep.has(activeEffect)) {\n    dep.add(activeEffect)\n  }\n}\n\n// 收集依赖中的结构大概类似如下\n// 比如 target 是 {name: 'xx', age: 'xx' }\n// key可能是 name，可能是 age，然后 key 对应的可能是多个 effect，应该是一个 set 类型\n//{name: 'xx', age: 'xx' } => name => [effect, effect]\n// 所以这里我们使用 weakMap\n// weakMap: key => { name:'zf',age: 12} value: map => {name => set}"],"names":[],"mappings":"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"}