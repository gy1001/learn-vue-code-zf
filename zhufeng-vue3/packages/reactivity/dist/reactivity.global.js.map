{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.ts","../src/baseHandler.ts","../src/reactive.ts","../src/effect.ts"],"sourcesContent":["export const isObject = (value) => {\n  return typeof value === 'object' && value !== null\n}\n\nexport const extend = Object.assign\n\nexport const isArray = Array.isArray\nexport const isFunction = (value) => typeof value === 'function'\nexport const isNumber = (value) => typeof value === 'number'\nexport const isString = (value) => typeof value === 'string'\nexport const isIntergerKey = (key) => parseInt(key) + '' === key\n\nlet hasOwnProperty = Object.prototype.hasOwnProperty\nexport const hasOwn = (target, key) => hasOwnProperty.call(target, key)\nexport const hasChanged = (oldValue, value) => oldValue !== value\n","// 实现 new Proxy(target, handler)\n// 是不是仅读的，仅读的属性 set 时候会报异常\n// 是不是深度的，\n\nimport {\n  extend,\n  hasChanged,\n  hasOwn,\n  isArray,\n  isIntergerKey,\n  isObject,\n} from '@vue/shared'\nimport {\n  reactive,\n  readonly,\n  track,\n  TrackOpTypes,\n  trigger,\n  TriggerOrTypes,\n} from '@vue/reactivity'\n\nfunction createGetter(isReadonly = false, shallow = false) {\n  return function get(target, key, receiver) {\n    // proxy + reflect\n    const res = Reflect.get(target, key, receiver)\n    // 后续 object 上的方法，会被迁移到 Reflect Reflect.getProptypeof()\n    // 以前 target[key] = value 方式 设置值可能会失败，但是并不会报异常，也没有返回值标识\n    // Reflect 方法具备返回值\n    // Reflect 使用可以不使用 proxy es6语法\n    if (!isReadonly) {\n      // 这里要收集依赖，等会数据变化后更新对应的视图\n      console.log('执行 effect 时候会取值，收集 effect')\n      track(target, TrackOpTypes.GET, key)\n    }\n    if (shallow) {\n      return res\n    }\n    if (isObject(res)) {\n      // vue2 是一上来就递归\n      // Vue3 是当取值的时候才进行带来，vue3的代理模式是懒代理\n      return isReadonly ? readonly(res) : reactive(res)\n    }\n    return res\n  }\n}\n\nconst get = createGetter()\nconst shallowGet = createGetter(false, true)\nconst readonlyGet = createGetter(true, false)\nconst shallowReadonlyGet = createGetter(true, true)\n\nfunction createSetter(shallow = false) {\n  return function set(target, key, value, receiver) {\n    // 先获取老值,在进行 Reflect.set 修改值之前\n    const oldValue = target[key]\n    // 这个判断也需要在 Reflect.set 前面\n    const hadKey =\n      isArray(target) && isIntergerKey(key)\n        ? Number(key) < target.length\n        : hasOwn(target, key)\n\n    const res = Reflect.set(target, key, value, receiver)\n    // 当数据更新的时候 ，通知对应属性的 effect 重新执行\n\n    // 这里我们要区分是新增的，还是修改的\n    // vue2中无法监控更改索引，无法监控数组的长度，因此 vue2中使用了 hack 的方法特殊处理了\n    // vue3中都解决了\n\n    // 这里判断 target 是数组，同时 key 是索引数字，即修改的是数组的索引\n    if (!hadKey) {\n      // 新增\n      trigger(target, TriggerOrTypes.ADD, key, value)\n    } else if (hasChanged(oldValue, value)) {\n      // 修改\n      trigger(target, TriggerOrTypes.SET, key, value, oldValue)\n    }\n    return res\n  }\n}\n\nconst set = createSetter()\nconst shallowSet = createSetter(true)\n\nexport const mutableHanders = {\n  get,\n  set,\n}\nexport const shallowReactiveHandlers = {\n  get: shallowGet,\n  set: shallowSet,\n}\n\nconst readonlyObj = {\n  set: (target, key) => {\n    console.warn(`set on ky ${key} failed`)\n  },\n}\nexport const readonlyHandlers = extend(\n  {\n    get: readonlyGet,\n  },\n  readonlyObj,\n)\nexport const shallowReadonlyHandlers = extend(\n  {\n    get: shallowReadonlyGet,\n  },\n  readonlyObj,\n)\n","import { isObject } from \"@vue/shared\";\nimport {\n  mutableHanders,\n  readonlyHandlers,\n  shallowReadonlyHandlers,\n  shallowReactiveHandlers,\n} from \"./baseHandler\";\n\nexport function reactive(target) {\n  return createReactiveObject(target, false, mutableHanders);\n}\n\nexport function shallowReactive(target) {\n  return createReactiveObject(target, false, shallowReactiveHandlers);\n}\n\nexport function readonly(target) {\n  return createReactiveObject(target, true, readonlyHandlers);\n}\n\nexport function shallowReadonly(target) {\n  return createReactiveObject(target, true, shallowReadonlyHandlers);\n}\n\n// 会垃圾回收，不会造成内存泄露， 存储的 key 只能是对象\nconst reactiveMap = new WeakMap();\nconst readonlyMap = new WeakMap();\n\n// 是不是深度，是不是仅读，做柯里化\n//new Proxy 最核心的需要拦截，数据的读取和数据的修改 get set\nexport function createReactiveObject(target, isReadonly, baseHandler) {\n  // 如果目标不是对象，没法拦截了，reactive 这个 api 只能拦截对象类型\n  if (!isObject(target)) {\n    return;\n  }\n  // 如果某个对象已经被代理过了，就不要再代理了。可能一个对象，被代理是深度，又被仅读代理了\n  const proxyMap = isReadonly ? readonlyMap : reactiveMap;\n\n  let existMap = proxyMap.get(target);\n  if (existMap) {\n    // 如果已经被代理了，就直接返回即可\n    return existMap;\n  }\n\n  const proxy = new Proxy(target, baseHandler);\n  // 将要代理的对象和对应代理结果缓存起来\n  proxyMap.set(target, proxy);\n\n  return proxy;\n}\n","import { isArray, isIntergerKey } from '@vue/shared'\nimport { TriggerOrTypes } from '@vue/reactivity'\n\nexport function effect(fn, options: any = {}) {\n  // 我们需要让这个 effect 变成响应式的 effect，可以做到数据变化重新执行\n\n  const effect = createReactiveEffect(fn, options)\n\n  if (!options.lazy) {\n    effect() // 响应式的 effect 默认会先执行一次\n  }\n  return effect\n}\n\nlet uid = 0\nlet activeEffect\nlet effectStack = [] // 存储当前的 effect,需要是个栈，因为可能会有嵌套的问题\n/*\neffect(() => {\n  state.name = \"xx\"\n  effect(() => {\n     state.age = \"xxx\"\n  })\n  state.address = \"xxx\"\n})\n\n\n */\n\nfunction createReactiveEffect(fn, options = {}) {\n  const effect = function reactiveEffect() {\n    if (effectStack.includes(effect)) {\n      // 这里可以防止如下代码\n      /**\n       effect(() => { state.age ++  })\n       // 如果没有做判断，就会循环执行\n       */\n      return\n    }\n    // 后续保证 effect 没有加入到 effectStack 中才进行添加\n\n    try {\n      // console.log(\"默认会执行\")\n      effectStack.push(effect)\n      activeEffect = effect\n      return fn() // 函数取值的时候会取值，执行 get，\n    } finally {\n      effectStack.pop()\n      activeEffect = effectStack[effectStack.length - 1]\n    }\n  }\n  effect.id = uid++ // 制作一个 effect 标识，用于区分 effect\n  effect._isEffect = true // 用于标识这个是响应式 effect\n  effect.raw = fn // 保留 effect 对应的原函数\n  effect.options = options // 在 effect 上保存用户的属性\n  return effect\n}\n\nconst targetMap = new WeakMap()\n\n// 让某个对象中的属性收集当前对应的 effect 函数\nexport function track(target, type, key) {\n  // 这里就可以拿到 activeEffect: 它是当前正在运行的 effect\n  // console.log(target, key, activeEffect)\n  if (activeEffect === undefined) {\n    // 此属性不用收集依赖，因为没在 effect 中使用\n    return\n  }\n  let depsMap = targetMap.get(target)\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map()))\n  }\n\n  let dep = depsMap.get(key)\n  if (!dep) {\n    depsMap.set(key, (dep = new Set()))\n  }\n  if (!dep.has(activeEffect)) {\n    dep.add(activeEffect)\n  }\n}\n\n// 收集依赖中的结构大概类似如下\n// 比如 target 是 {name: 'xx', age: 'xx' }\n// key可能是 name，可能是 age，然后 key 对应的可能是多个 effect，应该是一个 set 类型\n//{name: 'xx', age: 'xx' } => name => [effect, effect]\n// 所以这里我们使用 weakMap\n// weakMap: key => { name:'zf',age: 12} value: map => {name => set}\n\n// 找到对应的 effect 让其执行（数组、对象）\nexport function trigger(target, type, key, newValue?, oldValue?) {\n  console.log('trigger', target, type, key, newValue, oldValue)\n\n  // 如果这个属性没有收集过 effect, 那么不需要做任何操作\n  const depsMap = targetMap.get(target)\n  if (!depsMap) {\n    return\n  }\n  // 我要将所有的需要执行的 effect 全部存到一个新的集合中，最终一起执行\n  const effects = new Set() // 这里对 effect 进行了去重\n  const add = (effectsToAdd) => {\n    if (effectsToAdd) {\n      effectsToAdd.forEach((effect) => {\n        effects.add(effect)\n      })\n    }\n  }\n  // 1. 看修改的是否是数组的长度，因为修改长度影响的比较大\n  if (key === 'length' && isArray(target)) {\n    // 如果对应的长度有依赖收集\n    depsMap.forEach((dep, depKey) => {\n      if (depKey === 'length' || depKey > newValue) {\n        // length 改动，缩减了数组的长度\n        add(dep)\n      }\n    })\n  } else {\n    // 可能是对象\n    console.log(key)\n    if (key !== undefined) {\n      // 如果是新增，depsMap.get(key)就获取不到，也没有问题\n      add(depsMap.get(key))\n    }\n    // 如果修改数组中的某一个索引，怎么办？\n    // state.arr[100] = 1\n    // 这里添加一个索引的话，也需要添加 length 的 effect\n    switch (type) {\n      case TriggerOrTypes.ADD:\n        if (isArray(target) && isIntergerKey(key)) {\n          add(depsMap.get('length'))\n        }\n    }\n  }\n  effects.forEach((effect: any) => {\n    effect()\n  })\n}\n"],"names":[],"mappings":"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"}